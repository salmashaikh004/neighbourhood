<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Resource Details</title>

<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --page:#f8f7f1;
  --card:#efeade;
  --btn:#9bbc9b;
  --text:#153223;
}
*{box-sizing:border-box}

html,body{
  height:100%;
  margin:0;
  background:var(--page);
  font-family:Inter;
  display:flex;
  justify-content:center;
  padding:18px;
  color:var(--text);
}

.card{
  width:320px;
  height:600px;
  border-radius:34px;
  padding:18px;
  background:linear-gradient(180deg,var(--card),#fbf9f5);
  box-shadow:0 10px 26px rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
  position:relative;
  overflow:hidden;
}

.top{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:12px;
}

.backlink{cursor:pointer;font-weight:700;color:var(--btn)}
.title{font-family:Merriweather;font-size:20px}

.content{
  flex:1;
  overflow:auto;
  scrollbar-width:none;
}
.content::-webkit-scrollbar{display:none}

.slider{
  width:100%;
  height:240px;
  border-radius:18px;
  overflow:hidden;
  position:relative;
  margin-bottom:16px;
}

.slides{
  display:flex;
  height:100%;
  transition:transform 0.35s ease;
}

.slides img{
  width:100%;
  height:100%;
  object-fit:cover;
  flex:0 0 100%;
}

.nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  background:rgba(0,0,0,0.4);
  color:white;
  border:none;
  width:30px;
  height:30px;
  border-radius:50%;
  cursor:pointer;
  font-size:16px;
}
.prev{left:10px;}
.next{right:10px;}

.dots{
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:6px;
}
.dot{
  width:6px;
  height:6px;
  border-radius:50%;
  background:rgba(255,255,255,0.6);
  cursor:pointer;
}
.dot.active{background:white;}

.section{
  background:#fff;
  padding:12px;
  border-radius:14px;
  margin-bottom:12px;
}
.label{font-size:12px;opacity:0.6;margin-bottom:4px}
.value{font-weight:600}

.action-btn{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:var(--btn);
  font-weight:700;
  cursor:pointer;
}

.confirm-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.3);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;     /* IMPORTANT */
}

.confirm-box{
  background:white;
  width:320px;         /* fixed width */
  max-width:90%;
  padding:18px;
  border-radius:16px;
  text-align:center;
}
.confirm-actions{
  display:flex;
  gap:10px;
  margin-top:16px;
}
.confirm-actions button{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:none;
  cursor:pointer;
}
.cancel{background:#eee}
.confirm{background:var(--btn)}
</style>
</head>
<body>

<main class="card">

<div class="top">
  <div class="backlink" onclick="history.back()">←</div>
  <div class="title">Details</div>
</div>

<div class="content">

  <div class="slider">
    <div class="slides" id="imageSlides"></div>
    <button class="nav prev" id="prevBtn">&#10094;</button>
    <button class="nav next" id="nextBtn">&#10095;</button>
    <div class="dots" id="dots"></div>
  </div>

  <div class="section"><div class="label">Resource</div><div class="value" id="resourceName"></div></div>
  <div class="section"><div class="label">Owner</div><div class="value" id="ownerInfo"></div></div>
  <div class="section"><div class="label">Availability</div><div class="value" id="status"></div></div>
  <div class="section"><div class="label">Category</div><div class="value" id="category"></div></div>
  <div class="section"><div class="label">Description</div><div class="value" id="description"></div></div>
  <div class="section"><div class="label">Duration</div><div class="value" id="duration"></div></div>
  <div class="section"><div class="label">Location</div><div class="value" id="location"></div></div>
  <div class="section"><div class="label">Rules</div><div class="value" id="rules"></div></div>
  <div class="section"><div class="label">Terms</div><div class="value" id="terms"></div></div>

</div>

<button class="action-btn" id="requestBtn">Request to Borrow</button>

<div class="confirm-overlay" id="overlay">
  <div class="confirm-box">
    <div style="font-weight:700;">Send borrow request?</div>

    <!-- ADDED -->
    <input type="number" id="borrowDays" placeholder="How many days?" min="1" style="width:100%;margin-top:10px;padding:8px;border-radius:10px;border:1px solid #ddd;">

    <textarea id="borrowMessage" placeholder="Reason for borrowing"
      style="width:100%;margin-top:8px;padding:8px;border-radius:10px;border:1px solid #ddd;height:60px;"></textarea>
    <!-- END ADDED -->

    <div class="confirm-actions">
      <button class="cancel" id="cancelBtn">Cancel</button>
      <button class="confirm" id="yesBtn">Yes</button>
    </div>
  </div>
</div>

</main>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  addDoc, 
  collection, 
  serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDZU8DY5BYvU6UDFx9ry-VlwY70nA_mWdk",
  authDomain: "neighbourhood-app-d2ec2.firebaseapp.com",
  projectId: "neighbourhood-app-d2ec2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let resourceData = null;
let currentIndex = 0;

const resourceId = new URLSearchParams(window.location.search).get('id');
const slides = document.getElementById('imageSlides');
const dots = document.getElementById('dots');

/* AUTH CHECK */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.href = "signin.html";
    return;
  }
  currentUser = user;
  loadResource();
});

/* LOAD RESOURCE FROM FIRESTORE */
async function loadResource(){

  const snap = await getDoc(doc(db,"resources",resourceId));
  if(!snap.exists()){
    alert("Resource not found");
    return;
  }

  resourceData = snap.data();

  document.getElementById("resourceName").innerText = resourceData.name || "-";
  document.getElementById("status").innerText = resourceData.status || "Available";
  document.getElementById("category").innerText = resourceData.category || "-";
  document.getElementById("description").innerText = resourceData.description || "-";
  document.getElementById("duration").innerText = resourceData.duration || "-";
  document.getElementById("location").innerText = resourceData.location?.address || "-";
  document.getElementById("rules").innerText = resourceData.rules || "-";
  document.getElementById("terms").innerText = resourceData.terms || "-";
  document.getElementById("ownerInfo").innerText = resourceData.ownerName || "Owner";

  slides.innerHTML = "";
  dots.innerHTML = "";

  if(resourceData.images && resourceData.images.length){
    resourceData.images.forEach((img,i)=>{
      const image = document.createElement("img");
      image.src = img;
      slides.appendChild(image);

      const dot = document.createElement("div");
      dot.className = "dot" + (i===0 ? " active":"");
      dot.onclick = ()=>{ currentIndex = i; updateSlider(); };
      dots.appendChild(dot);
    });
  }
}

function updateSlider(){
  slides.style.transform = `translateX(-${currentIndex*100}%)`;
  document.querySelectorAll('.dot').forEach((d,i)=>{
    d.classList.toggle("active", i===currentIndex);
  });
}

document.getElementById("prevBtn").onclick=()=>{
  if(currentIndex>0){ currentIndex--; updateSlider(); }
};

document.getElementById("nextBtn").onclick=()=>{
  if(resourceData?.images && currentIndex<resourceData.images.length-1){
    currentIndex++; updateSlider();
  }
};

/* BORROW REQUEST POPUP */
const overlay = document.getElementById("overlay");
const requestBtn = document.getElementById("requestBtn");
const cancelBtn = document.getElementById("cancelBtn");
const yesBtn = document.getElementById("yesBtn");

requestBtn.onclick = ()=> overlay.style.display="flex";
cancelBtn.onclick = ()=> overlay.style.display="none";

yesBtn.onclick = async ()=>{

  const days = parseInt(document.getElementById("borrowDays").value);
  const message = document.getElementById("borrowMessage").value;

  if(!days || days <= 0){
    alert("Enter valid number of days");
    return;
  }

  await addDoc(collection(db,"requests"),{
    resourceId: resourceId,
    resourceName: resourceData.name,
    ownerId: resourceData.userId,
    ownerName: resourceData.ownerName || "",
    requesterId: currentUser.uid,
    requesterName: currentUser.displayName || "",
    borrowDays: days,
    message: message,
    status: "pending",
    createdAt: serverTimestamp()
  });

  overlay.style.display = "none";
  alert("Request Sent Successfully");
  window.location.href="borrow-dashboard.html";
};

</script>
</script>

</body>
</html>