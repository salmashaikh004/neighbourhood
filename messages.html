 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messages</title>

<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#e6f0e8;
  --panel:#ffffff;
  --text:#123326;
  --muted:#6b7d73;
  --line:#d8e4dc;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:Inter,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.app{
  width:320px;
  height:600px;
  border-radius:28px;
  background:linear-gradient(180deg,#dbeadb,#e4f0e6);
  box-shadow:0 12px 30px rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.header{
  padding:16px;
  display:flex;
  align-items:center;
  gap:12px;
  font-family:Merriweather,serif;
  font-size:20px;
  font-weight:700;
}
.back{cursor:pointer;font-size:18px;}
.search-box{padding:0 16px 12px;}
.search-box input{
  width:100%;
  padding:10px 14px;
  border-radius:20px;
  border:none;
  outline:none;
  background:#f3f8f3;
  font-size:13px;
}
.chat-list{
  flex:1;
  overflow-y:auto;
  padding:0 10px 10px 10px;
}
.chat-card{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:16px;
  cursor:pointer;
  transition:0.2s;
  background:white;
  margin-bottom:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.04);
}
.chat-card:hover{background:#f3f8f3;}
.avatar{
  width:46px;
  height:46px;
  border-radius:50%;
  background:#cfe2d5;
  object-fit:cover;
}
.chat-info{
  flex:1;
  display:flex;
  flex-direction:column;
}
.name{
  font-weight:600;
  font-size:14px;
  color:var(--text);
}
.preview{
  font-size:12px;
  color:var(--muted);
  margin-top:3px;
}
.time{
  font-size:11px;
  color:var(--muted);
}
.empty{
  text-align:center;
  margin-top:60px;
  font-size:13px;
  color:var(--muted);
}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <div class="back" onclick="goBack()">←</div>
    Messages
  </div>

  <div class="search-box">
    <input type="text" placeholder="Search conversations">
  </div>

  <div class="chat-list" id="chatList"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot,
  orderBy,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDZU8DY5BYvU6UDFx9ry-VlwY70nA_mWdk",
  authDomain: "neighbourhood-app-d2ec2.firebaseapp.com",
  projectId: "neighbourhood-app-d2ec2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, (user)=>{
  if(!user){
    window.location.href = "signin.html";
    return;
  }
  currentUser = user;
  listenChats(user.uid);
});

/* ===== TIME FORMAT ===== */

function formatWhatsAppTime(timestamp){
  if(!timestamp) return "";

  const messageDate = new Date(timestamp.seconds * 1000);
  const now = new Date();
  const diffMs = now - messageDate;
  const diffHours = diffMs / (1000 * 60 * 60);

  if(diffHours < 24){
    return messageDate.toLocaleTimeString([], {
      hour:'2-digit', minute:'2-digit'
    });
  } else {
    return messageDate.toLocaleDateString();
  }
}

/* ===== REALTIME CHAT LIST ===== */

function listenChats(uid){

  const container = document.getElementById("chatList");

  const q = query(
    collection(db,"chats"),
    where("participants","array-contains",uid)
  );

  onSnapshot(q, async(snapshot)=>{

    container.innerHTML = "";

    if(snapshot.empty){
      container.innerHTML =
        `<div class="empty">No conversations yet</div>`;
      return;
    }

    const chats = [];

    snapshot.forEach(docSnap=>{
      chats.push({id:docSnap.id, ...docSnap.data()});
    });

    // Sort newest first
    chats.sort((a,b)=>{
      const aTime = a.updatedAt?.seconds || 0;
      const bTime = b.updatedAt?.seconds || 0;
      return bTime - aTime;
    });

    for(const chat of chats){

      const otherUserId =
        chat.participants.find(id => id !== uid);

      const userSnap = await getDoc(doc(db,"users",otherUserId));

      let otherUserName = "User";
      let otherUserPhoto = "https://via.placeholder.com/45";

      if(userSnap.exists()){
        const userData = userSnap.data();
        otherUserName = userData.displayName || "User";
        otherUserPhoto = userData.photo || "https://via.placeholder.com/45";
      }

      const card = document.createElement("div");
      card.className = "chat-card";

      card.onclick = ()=>{
        window.location.href =
          "chat.html?chatId="+chat.id;
      };

      card.innerHTML = `
        <img class="avatar"
             src="${otherUserPhoto}"
             onclick="event.stopPropagation(); openProfile('${otherUserId}')">

        <div class="chat-info">
          <div class="name">${otherUserName}</div>
          <div class="preview">${chat.lastMessage || ""}</div>
        </div>

        <div class="time">
          ${chat.updatedAt
            ? formatWhatsAppTime(chat.updatedAt)
            : ""}
        </div>
      `;

      container.appendChild(card);
    }

  });

}

/* ===== PROFILE NAVIGATION ===== */

window.openProfile = function(uid){
  window.location.href = "my_profile.html?uid=" + uid;
};

window.goBack = function(){
  window.location.href = "home.html";
};

</script>

</body>
</html>