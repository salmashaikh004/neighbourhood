<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Local Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:Inter, Arial;
  background:#f6faf6;
  display:flex;
  justify-content:center;
  padding:20px;
}

.app{
  width:320px;
  height:600px;
  border-radius:30px;
  background:linear-gradient(180deg,#cdddcf,#e2efe3);
  box-shadow:0 15px 35px rgba(0,0,0,0.08);
  position:relative;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.header{
  padding:16px;
  display:flex;
  align-items:center;
  gap:10px;
}

.back{
  font-size:18px;
  cursor:pointer;
}

h1{
  font-family:Merriweather, serif;
  font-size:20px;
  margin:0;
}

/* SEARCH */
.search-box{
  background:white;
  border-radius:18px;
  padding:10px 14px;
  box-shadow:0 6px 15px rgba(0,0,0,0.06);
  margin:12px 16px 10px 16px;
}

.search-box input{
  border:none;
  outline:none;
  width:100%;
  font-size:14px;
}

/* CATEGORY */
.categories{
  display:flex;
  gap:8px;
  overflow-x:auto;
  padding:0 16px 8px 16px;
  scrollbar-width:none;
  -ms-overflow-style:none;
}
.categories::-webkit-scrollbar{
  display:none;
}

.categories button{
  border:none;
  padding:8px 14px;
  border-radius:20px;
  background:#ffffff;
  font-size:13px;
  cursor:pointer;
  white-space:nowrap;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

.categories button.active{
  background:#9bbc9b;
  color:#0d2a18;
  font-weight:600;
}

/* MAP */
#map{
  flex:1;
}

/* MY LOCATION BUTTON */
.my-location{
  position:absolute;
  bottom:120px;
  right:16px;
  width:42px;
  height:42px;
  border-radius:50%;
  background:white;
  box-shadow:0 6px 18px rgba(0,0,0,0.15);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:18px;
  z-index:1000;
}

/* PREVIEW */
.preview{
  position: absolute;
  left: 0;
  right: 0;
  bottom: -220px; /* hidden state */
  background: #ffffff;
  border-radius: 24px 24px 0 0;
  padding: 18px 18px 22px 18px;
  box-shadow: 0 -10px 25px rgba(0,0,0,0.12);
  transition: bottom 0.35s ease;
  z-index: 999;
}

.preview.show{
  bottom: 0;
}
.preview h3{
  margin: 0;
  font-size: 16px;
  font-weight: 700;
}

.preview p{
  margin: 6px 0 16px 0;
  font-size: 13px;
  opacity: 0.7;
}

.preview button{
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  border-radius: 16px;
  border: none;
  font-weight: 600;
  background: #9bbc9b;
  cursor: pointer;
}
.preview{
  padding-bottom: 26px;
}
#map{
  z-index: 1;
}

.preview{
  z-index: 2000;
}
</style>
</head>

<body>

<div class="app">

  <!-- HEADER WITH BACK -->
  <div class="header">
    <div class="back" onclick="history.back()">←</div>
    <h1>Local Map</h1>
  </div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search items..." oninput="applyFilter()">
  </div>

  <div class="categories">
    <button class="active" onclick="setCategory('all',this)">All</button>
    <button onclick="setCategory('Books',this)">Books</button>
    <button onclick="setCategory('Tools',this)">Tools</button>
    <button onclick="setCategory('Electronics',this)">Electronics</button>
    <button onclick="setCategory('Kitchen',this)">Kitchen</button>
  </div>

  <div id="map"></div>

  <div class="my-location" onclick="goToMyLocation()">📍</div>

  <div id="preview" class="preview">

  <div onclick="closePreview()" style="
    text-align:right;
    font-size:18px;
    cursor:pointer;
    margin-bottom:8px;
  ">✕</div>
    <h3 id="itemName"></h3>
    <p id="itemCategory"></p>
    <button onclick="goToDetails()">View Details</button>
  </div>

</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyDZU8DY5BYvU6UDFx9ry-VlwY70nA_mWdk",
  authDomain: "neighbourhood-app-d2ec2.firebaseapp.com",
  projectId: "neighbourhood-app-d2ec2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= VARIABLES ================= */

let map;
let userLocation;
let allResources = [];
let markers = [];
let selectedCategory = "all";
let selectedItem = null;

/* ================= AUTH ================= */

onAuthStateChanged(auth, user => {
  if(!user){
    window.location.href = "signin.html";
    return;
  }
  initMap();
});

/* ================= INIT MAP ================= */
const myIcon = L.icon({
  iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
  iconSize: [32, 32],
  iconAnchor: [16, 32]
});

const resourceIcon = L.icon({
  iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
  iconSize: [32, 32],
  iconAnchor: [16, 32]
});
function initMap(){

  navigator.geolocation.getCurrentPosition(async pos => {

    userLocation = [pos.coords.latitude, pos.coords.longitude];

    map = L.map("map").setView(userLocation, 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
      .addTo(map);

   L.marker(userLocation, {
  icon: myIcon,
  zIndexOffset: 0
}).addTo(map);

    await loadResources();

  }, () => {
    alert("Location permission needed");
  });
}

/* ================= LOAD FIRESTORE ================= */

async function loadResources(){

  const snapshot = await getDocs(collection(db,"resources"));
  allResources = [];

  snapshot.forEach(docSnap => {

    const data = docSnap.data();

    if(!data.location?.lat || !data.location?.lng) return;

    const distance = calculateDistance(
      userLocation[0],
      userLocation[1],
      data.location.lat,
      data.location.lng
    );

    allResources.push({
      id: docSnap.id,
      name: data.name || "",
      category: (data.category || "").toLowerCase(),
      description: data.description || "",
      lat: data.location.lat,
      lng: data.location.lng,
      distance: distance
    });

  });

  // SORT BY DISTANCE (closest first)
  allResources.sort((a,b)=>a.distance-b.distance);

  applyFilters();
}

/* ================= DISTANCE FUNCTION ================= */

function calculateDistance(lat1, lon1, lat2, lon2){

  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // distance in KM
}

/* ================= FILTER SYSTEM ================= */

window.setCategory = function(cat, btn){

  selectedCategory = cat.toLowerCase();

  document.querySelectorAll(".categories button")
    .forEach(b=>b.classList.remove("active"));

  btn.classList.add("active");

  applyFilters();
};

window.applyFilter = function(){
  applyFilters();
};

function applyFilters(){

  const search =
    document.getElementById("searchInput")
      .value.toLowerCase().trim();

  let filtered = [...allResources];

  if(selectedCategory !== "all"){
    filtered = filtered.filter(item =>
      item.category.includes(selectedCategory)
    );
  }

  if(search){
    filtered = filtered.filter(item =>
      item.name.toLowerCase().includes(search) ||
      item.category.includes(search) ||
      item.description.toLowerCase().includes(search)
    );
  }

  renderMarkers(filtered);
}

/* ================= RENDER MARKERS ================= */

function renderMarkers(resources){

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  if(resources.length === 0){
    console.log("No matching resources");
    return;
  }

  resources.forEach(item => {

    // small offset if same as user location
let lat = item.lat;
let lng = item.lng;

if(
  Math.abs(lat - userLocation[0]) < 0.0001 &&
  Math.abs(lng - userLocation[1]) < 0.0001
){
  lat += 0.0003;
  lng += 0.0003;
}

const marker = L.marker([lat, lng], {
  icon: resourceIcon,
  zIndexOffset: 1000
})
      .addTo(map)
      .on("click", ()=>openPreview(item));

    markers.push(marker);
  });

  console.log("Nearby resources:", resources.length);
}

/* ================= PREVIEW ================= */

function openPreview(item){

  selectedItem = item;

  document.getElementById("itemName").innerText =
    item.name + " (" + item.distance.toFixed(1) + " km away)";

  document.getElementById("itemCategory").innerText =
    item.category;

  document.getElementById("preview")
    .classList.add("show");

  // Move map slightly up
  map.panBy([0, -120]);
}
window.closePreview = function(){
  document.getElementById("preview")
    .classList.remove("show");
};

/* ================= NAVIGATION ================= */

window.goToDetails = function(){
  if(selectedItem){
    window.location.href =
      "resource-details.html?id=" + selectedItem.id;
  }
};

window.goToMyLocation = function(){
  map.flyTo(userLocation, 14);
};

</script>

</body>
</html>






